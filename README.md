# LoRaScope - LoRa 射频环境感知工具

基于 M5Cardputer 的LoRa 射频环境感知工具，通过周期性扫描多个频点，采样 RSSI/SNR/接收结果，来推断无线活动强度，并以"图表"形式在屏幕上展示。

## 功能特性

- **多频点扫描**：支持配置多个频点进行周期性扫描
- **实时监测**：实时显示 RSSI、SNR 和数据包接收情况
- **活动评分**：基于多因子算法计算每个频点的活动强度
- **多种显示模式**：
  - Timeline（时间线）：显示最近60秒的接收事件时间线
  - RSSI Histogram（RSSI直方图）：以条形图形式展示信号强度分布
  - Event List（事件列表）：详细显示最近的接收事件
  - Statistics（统计信息）：显示接收统计数据和成功率
  - Frequency Comparison（频点对比）：显示所有配置的频点列表
  - Realtime Monitor（实时监测）：显示最近10秒的实时信号
  - Radar（雷达）：可视化显示不同频点的信号分布和强度
- **模块支持**：（计划）支持多种 LoRa 模块
  - E220-433/868/915 系列
  - SX1262 模块
  - RF95 模块
- **硬件兼容**：支持 M5Cardputer 标准版和 ADV 版（暂未测试）

## 硬件要求

- M5Cardputer (ESP32-S3)
- LoRa E220-433模块（目前仅测试了该模块）

## 快速开始

### 1. 在M5bunner中烧录固件

### 2. 使用说明

设备启动后会自动开始扫描。按键功能：

- **0**：切换到 Radar（雷达）视图
- **1**：切换到 Timeline（时间线）视图
- **2**：切换到 RSSI Histogram（RSSI直方图）视图
- **3**：切换到 Event List（事件列表）视图
- **4**：切换到 Statistics（统计信息）视图
- **5**：切换到 Frequency Comparison（频点对比）视图
- **6**：切换到 Realtime Monitor（实时监测）视图
- **-**：上一个频点
- **=**：下一个频点
- **s**：开始/停止扫描
- **c**：清除统计数据

## 显示视图详解

### 视图1：Timeline（时间线视图）

#### 显示内容
- **X轴**：时间（最近60秒）
- **Y轴**：信号强度（-120 dBm 到 -50 dBm）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径4） | 成功接收数据包 |
| 🟢 绿色 | 小（半径2） | 成功接收但无数据 |
| 🔴 红色 | 小（半径2） | CRC错误 |

#### 如何阅读
1. **查看信号分布**：圆点越靠上，信号越强
2. **查看活动频率**：圆点越密集，该频点活动越频繁
3. **查看接收质量**：绿色点多表示接收成功，红色点多表示干扰或信号质量差
4. **查看时间趋势**：从右到左，越靠左越早

---

### 视图2：RSSI Histogram（RSSI直方图）

#### 显示内容
- **X轴**：信号强度范围（-120 dBm 到 -50 dBm，分为10个区间）
- **Y轴**：每个信号强度区间的事件数量
- **柱状图**：显示信号强度的分布情况

#### 图例
| 柱状图颜色 | RSSI 范围 | 含义 |
|-----------|-----------|------|
| 🟢 绿色 | > -80 dBm | 信号强 |
| 🟡 黄色 | -100 ~ -80 dBm | 信号中等 |
| 🔴 红色 | < -100 dBm | 信号弱 |

#### 如何阅读
1. **查看信号分布**：柱子越高，该信号强度区间的事件越多
2. **判断信号质量**：如果绿色柱子高，说明信号质量好；如果红色柱子高，说明信号质量差
3. **判断干扰情况**：如果柱子集中在低信号强度区域，可能存在干扰或距离较远
4. **优化天线位置**：调整天线位置，观察直方图变化，找到最佳位置

---

### 视图3：Event List（事件列表）

#### 显示内容
- **列表**：显示最近的接收事件（最多显示屏幕能容纳的行数）
- **每行信息**：
  - 左侧色条：事件类型
  - RSSI：信号强度
  - Len：数据包长度
  - T：距离现在的时间（秒）

#### 图例
| 左侧色条 | 含义 |
|---------|------|
| 🟢 绿色 | 成功接收数据包 |
| 🔴 红色 | CRC错误 |

#### 如何阅读
```
示例行：
🟢 RSSI:-65 Len:12 T:5s
│   │    │     │    │
│   │    │     │    └─ 距离现在5秒
│   │    │     └───── 数据包长度12字节
│   │    └────────── 信号强度-65 dBm
│   └─────────────── 成功接收（绿色）
└────────────────── 色条
```

1. **查看最近事件**：最新事件在列表底部
2. **查看事件类型**：绿色表示成功，红色表示错误
3. **查看信号强度**：RSSI值越小（越接近0），信号越强
4. **查看数据包大小**：Len值表示接收到的数据包长度
5. **查看时间**：T值表示事件发生的时间

---

### 视图4：Statistics（统计信息）

#### 显示内容
- **总事件数**：所有接收事件的总数
- **RX Done**：成功接收的事件数
- **RX Error**：CRC错误的事件数
- **Avg RSSI**：平均信号强度
- **Max RSSI**：最大信号强度
- **Min RSSI**：最小信号强度
- **Success Rate**：接收成功率

#### 如何阅读
```
Total Events:  150
RX Done:      145  🟢
RX Error:       5  🔴
Avg RSSI:    -72 dBm
Max RSSI:    -55 dBm
Min RSSI:   -115 dBm
Success Rate:  96.7%
```

1. **总事件数**：了解该频点的活动强度
2. **RX Done vs RX Error**：
   - 如果 RX Done 远大于 RX Error：信号质量好
   - 如果 RX Error 较多：可能存在干扰或信号质量差
3. **Avg RSSI**：了解平均信号强度，判断通信质量
4. **Max/Min RSSI**：了解信号强度范围
5. **Success Rate**：
   - > 90%：优秀
   - 70-90%：良好
   - 50-70%：一般
   - < 50%：较差

---

### 视图5：Frequency Comparison（频点对比）

#### 显示内容
- **列表**：显示所有配置的频点
- **每行信息**：
  - 频率值（MHz）
  - 当前频点高亮显示

#### 图例
| 显示 | 含义 |
|------|------|
| 普通文本 | 其他频点 |
| 青色高亮 | 当前选中的频点 |

#### 如何阅读
```
示例：
433.05 MHz
433.15 MHz
433.25 MHz  ← 当前频点（青色高亮）
433.35 MHz
...
```

1. **查看所有频点**：列表显示所有配置的频点
2. **快速切换频点**：使用 `-` 和 `=` 键切换，列表会滚动显示
3. **查看当前频点**：当前频点以青色高亮显示
4. **对比频点**：可以快速浏览所有频点，选择合适的频点

---

### 视图6：Realtime Monitor（实时监测）

#### 显示内容
- **X轴**：时间（最近10秒）
- **Y轴**：信号强度（-120 dBm 到 -50 dBm）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径3） | 成功接收数据包 |
| 🟢 绿色 | 小（半径2） | 成功接收但无数据 |
| 🔴 红色 | 小（半径2） | CRC错误 |

#### 如何阅读
1. **查看实时信号**：圆点越靠上，信号越强
2. **查看信号波动**：圆点分布越集中，信号越稳定
3. **查看接收质量**：绿色点多表示接收成功，红色点多表示干扰或信号质量差
4. **查看时间趋势**：从右到左，越靠左越早

---

### 视图0：Radar（雷达视图）

#### 显示内容
- **圆形雷达图**：显示不同频点的信号分布
- **同心圆**：表示信号强度（外圈弱，内圈强）
- **角度位置**：表示频点位置（从起始频率到结束频率围绕圆圈展开）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径3） | 信号强（> -70 dBm） |
| 🟡 黄色 | 大（半径3） | 信号中等（-80 ~ -70 dBm） |
| 🟠 橙色 | 大（半径3） | 信号弱（-90 ~ -80 dBm） |
| 🔴 红色 | 大/小（半径3/2） | CRC错误 |

#### 如何阅读
1. **查看频点分布**：不同角度代表不同频点，从起始频率到结束频率顺时针排列
2. **查看信号强度**：圆点越靠近中心，信号越强；越靠近外圈，信号越弱
3. **查看信号质量**：绿色表示强信号，黄色表示中等信号，橙色表示弱信号，红色表示错误
4. **查看活动密度**：某个角度的点越密集，表示该频点活动越频繁
5. **查看信号稳定性**：某个角度的点越集中，表示该频点信号越稳定

---

### 状态栏说明

状态栏显示以下信息：

| 元素 | 位置 | 说明 |
|------|------|------|
| 模块名称 | 左侧 | 显示 LoRa 模块名称（如 "E220"） |
| 频率 | 中间 | 显示当前扫描频率（如 "433.05 MHz"） |
| 频点索引 | 中右 | 显示当前频点索引（如 "5/18"） |
| 扫描图标 | 右侧 | 🟢 绿色：正在扫描，⚪ 灰色：已停止 |
| RSSI指示器 | 右侧 | 显示最近一次接收的信号强度（4格） |
| 电池指示器 | 右侧 | 显示电池电量 |

#### RSSI指示器图例
| 格数 | 颜色 | RSSI 范围 | 含义 |
|------|------|-----------|------|
| 4格 | 🟢 绿色 | > -70 dBm | 信号很强 |
| 3格 | 🟢 绿色 | -80 ~ -70 dBm | 信号强 |
| 2格 | 🟡 黄色 | -90 ~ -80 dBm | 信号中等 |
| 1格 | 🔴 红色 | -100 ~ -90 dBm | 信号弱 |
| 0格 | 无显示 | < -100 dBm | 无信号 |

---

### 使用建议

1. **快速查看信号质量**：使用 Timeline 视图
2. **分析信号分布**：使用 RSSI Histogram 视图
3. **查看详细事件**：使用 Event List 视图
4. **查看统计数据**：使用 Statistics 视图
5. **对比所有频点**：使用 Frequency Comparison 视图
6. **实时监测信号**：使用 Realtime Monitor 视图
7. **可视化频点分布**：使用 Radar 视图

---

## 按键功能说明

| 按键 | 功能 |
|------|------|
| 0 | Radar（雷达）视图 |
| 1 | Timeline（时间线）视图 |
| 2 | RSSI Histogram（RSSI直方图）视图 |
| 3 | Event List（事件列表）视图 |
| 4 | Statistics（统计信息）视图 |
| 5 | Frequency Comparison（频点对比）视图 |
| 6 | Realtime Monitor（实时监测）视图 |
| - | 上一个频点 |
| = | 下一个频点 |
| s | 开始/停止扫描 |
| c | 清除统计数据 |
7. **综合分析**：切换不同视图，全面了解频点情况

---## 项目结构

```
LoRaScope/
├── src/
│   ├── main.cpp              # 主程序
│   ├── common.h              # 公共数据结构和定义
│   ├── lora_adapter.h/cpp    # LoRa 模块抽象层
│   ├── scanner.h/cpp          # 频点扫描核心模块
│   ├── statistics.h/cpp       # 数据统计与评分模块
│   └── display.h/cpp         # UI 显示模块
├── platformio.ini            # PlatformIO 配置
└── README.md                 # 本文件
```

## 配置说明

### 频点配置

在 `src/config_user.h` 中修改 `getUserConfig()` 函数来配置扫描参数：

```cpp
LoRaScopeConfig getUserConfig() {
    LoRaScopeConfig config;
    
    // 频率范围
    config.startFreqHz = 433050000;   // 起始频率：433.05 MHz
    config.endFreqHz = 434790000;     // 结束频率：434.79 MHz
    config.freqStepHz = 100000;        // 频率步进：100 kHz
    
    // LoRa 参数
    config.rxWindowMs = 1000;          // RX窗口：1000 ms
    config.bandwidth = 125;            // 带宽：125 kHz
    config.spreadingFactor = 9;        // 扩频因子：SF9
    config.codingRate = 5;             // 编码率：4/5
    config.maxPoints = 100;           // 最大雷达点数：100
    
    return config;
}
```

#### 频率步进选项

| 步进 | 值（Hz） | 说明 |
|------|-----------|------|
| 100 kHz | 100000 | 默认值 最小步进（E220支持） |
| 200 kHz | 200000 |  |
| 500 kHz | 500000 |  |
| 1 MHz | 1000000 |  |
| 2 MHz | 2000000 |  |

#### LoRa 参数说明

| 参数 | 常用值 | 说明 |
|------|---------|------|
| rxWindowMs | 500-2000 | 每个频点的停留时间（毫秒） |
| bandwidth | 125, 250, 500 | 带宽（kHz），值越大速率越高但灵敏度越低 |
| spreadingFactor | 7-12 | 扩频因子，值越大灵敏度越高但速率越低 |
| codingRate | 5, 6, 7, 8 | 编码率（4/5, 4/6, 4/7, 4/8），值越小纠错能力越强 |
| maxPoints | 50-200 | 最大雷达点数，值越大显示越详细但占用更多内存 |

### 扩展其他 LoRa 模块

#### 使用 SX1262 模块

1. 在 `platformio.ini` 中选择 `m5cardputer_sx1262` 环境
2. 在 `main.cpp` 中修改初始化代码：

```cpp
#include <RadioLib.h>

SX1262 lora = new Module(15, 16, 4, 5);  // CS, IRQ, RST, BUSY
LoRaAdapter* loraAdapter = new SX1262Adapter(&lora, &SPI, 15, 16, 4, 5);
```

#### 使用 RF95 模块

1. 在 `platformio.ini` 中选择 `m5cardputer_rf95` 环境
2. 在 `main.cpp` 中修改初始化代码：

```cpp
#include <RadioLib.h>

RFM95 lora = new Module(15, 16, 4);  // CS, IRQ, RST
LoRaAdapter* loraAdapter = new RF95Adapter(&lora, &SPI, 15, 16, 4);
```

## 活动评分算法

活动评分基于以下四个因子：

1. **信号强度 (35%)**：RSSI 越高，评分越高
2. **数据包频率 (30%)**：接收到的数据包越多，评分越高
3. **信号稳定性 (20%)**：信号越稳定，评分越高
4. **时间新鲜度 (15%)**：最近检测到活动的频点评分更高

评分范围：0.0 - 1.0

## 扩展方向

### Phase 2 功能

- 频点自动发现（扫描整个 433MHz ISM 频段）
- 历史数据记录到 SD 卡
- 阈值告警（检测到异常活动时提示）
- 数据导出（CSV/JSON）

### Phase 3 功能

- 多设备协同扫描
- 网络同步（ESP-NOW）
- 高级分析（模式识别、周期性检测）


## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！
