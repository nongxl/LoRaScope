# LoRaScope 项目实现总结

## 项目概述

LoRaScope 是一个基于 M5Cardputer 的 LoRa 射频环境感知工具，通过周期性扫描多个频点，采样 RSSI/SNR/接收结果，来推断无线活动强度，并以多种可视化形式在屏幕上展示。

## 已实现的功能

### 1. 核心模块

#### 1.1 LoRa 模块抽象层 ([lora_adapter.h/cpp](src/lora_adapter.h))
- **设计目标**：支持多种 LoRa 模块，便于扩展
- **已实现**：
  - E220-433/868/915 系列适配器
  - 统一的 LoRaAdapter 接口
  - 工厂模式创建适配器

**设计理由**：
- 使用抽象接口隔离不同模块的实现细节
- 工厂模式简化适配器创建
- 便于未来添加新的 LoRa 模块支持

#### 1.2 频点监听模块 ([scanner.h/cpp](src/scanner.h))
- **设计目标**：高效、可靠的频点监听和扫描
- **已实现**：
  - FreeRTOS 任务独立运行监听，不阻塞 UI
  - 支持用户手动切换频点（`-` 和 `=` 键）
  - 每个频点可配置 RX 窗口时间、带宽、扩频因子、编码率
  - 实时采样 RSSI、SNR 和数据包接收情况
  - 自动记录接收事件（成功接收、CRC错误）

**设计理由**：
- 使用 FreeRTOS 任务确保监听不阻塞主循环
- 用户手动切换频点，灵活性强
- 支持灵活的 LoRa 参数配置

#### 1.3 数据统计模块 ([statistics.h/cpp](src/statistics.h))
- **设计目标**：准确记录和统计接收事件
- **已实现**：
  - 滑动窗口记录最近 100 个雷达点
  - 数据包接收统计
  - CRC 错误计数
  - RSSI 统计（平均值、最大值、最小值）

**设计理由**：
- 滑动窗口避免历史数据过多
- 限制内存使用
- 提供稳定的统计结果

#### 1.4 UI 显示模块 ([display.h/cpp](src/display.h))
- **设计目标**：直观、友好的用户界面
- **已实现**：
  - **Timeline（时间线）视图**：显示最近60秒的接收事件时间线
  - **RSSI Histogram（RSSI直方图）视图**：以条形图形式展示信号强度分布
  - **Event List（事件列表）视图**：详细显示最近的接收事件
  - **Statistics（统计信息）视图**：显示接收统计数据和成功率
  - **Frequency Comparison（频点对比）视图**：显示所有配置的频点列表
  - **Realtime Monitor（实时监测）视图**：显示最近10秒的实时信号
  - **Radar（雷达）视图**：圆形雷达展示各频点信号分布和强度（默认视图）
  - 系统状态栏：显示模块名称、当前频率、扫描状态、RSSI、电池电量

**设计理由**：
- 七种显示模式适应不同使用场景
- 颜色编码（绿/黄/红/橙）直观表示信号强度
- 实时更新提供即时反馈
- 雷达视图作为默认视图，直观展示频点分布

### 2. 配置和构建

#### 2.1 配置系统
- **config.h**：框架配置
  - 定义配置结构 `LoRaScopeConfig`
  - 提供默认值和频率列表生成方法
- **config_user.h**：用户配置
  - 用户可自定义频率范围（startFreqHz、endFreqHz、freqStepHz）
  - 用户可自定义 LoRa 参数（rxWindowMs、bandwidth、spreadingFactor、codingRate）
  - 用户可自定义最大雷达点数（maxPoints）

**设计理由**：
- 分离框架配置和用户配置
- 用户只需修改 config_user.h 即可自定义功能
- 提供合理的默认值

#### 2.2 PlatformIO 配置 ([platformio.ini](platformio.ini))
- **已实现**：
  - M5Cardputer 标准版环境
  - 使用 M5GFX、M5Unified、M5Cardputer 库
  - 使用 M5-LoRa-E220 库

**设计理由**：
- 针对 M5Cardputer 优化配置
- 使用官方库确保兼容性

### 3. 项目结构

```
LoRaScope/
├── src/
│   ├── main.cpp              # 主程序入口
│   ├── common.h              # 公共数据结构和定义
│   ├── config.h              # 框架配置
│   ├── config_user.h         # 用户配置
│   ├── lora_adapter.h/cpp    # LoRa 模块抽象层
│   ├── scanner.h/cpp          # 频点监听核心模块
│   ├── statistics.h/cpp       # 数据统计模块
│   └── display.h/cpp         # UI 显示模块
├── platformio.ini            # PlatformIO 配置
├── .gitignore               # Git 忽略文件
└── README.md                # 项目说明文档
```

## 技术亮点

### 1. 模块化设计
- 清晰的模块划分，职责单一
- 接口抽象，便于扩展和维护
- 低耦合，高内聚

### 2. 可扩展性
- LoRa 模块抽象层支持多种模块
- 频点配置灵活，易于添加新频点
- 显示模式可扩展（当前7种）

### 3. 实时性
- FreeRTOS 任务独立运行监听
- 不阻塞 UI 和用户输入
- 实时更新显示

### 4. 资源管理
- 滑动窗口限制内存使用（最多100个雷达点）
- 定期清理过期数据
- 智能指针管理对象生命周期

### 5. 用户体验
- 七种显示模式，适应不同需求
- 直观的颜色编码
- 简单的按键操作
- 雷达视图默认显示，一目了然

## 使用方法

### 1. 编译和上传

```bash
# 使用 PlatformIO
pio run
pio run --target upload
```

### 2. 按键操作

| 按键 | 功能 |
|------|------|
| 0 | Radar（雷达）视图 |
| 1 | Timeline（时间线）视图 |
| 2 | RSSI Histogram（RSSI直方图）视图 |
| 3 | Event List（事件列表）视图 |
| 4 | Statistics（统计信息）视图 |
| 5 | Frequency Comparison（频点对比）视图 |
| 6 | Realtime Monitor（实时监测）视图 |
| - | 上一个频点 |
| = | 下一个频点 |
| s | 开始/停止扫描 |
| c | 清除统计数据 |

### 3. 配置频点

在 [config_user.h](src/config_user.h) 中修改 `getUserConfig()` 函数：

```cpp
LoRaScopeConfig getUserConfig() {
    LoRaScopeConfig config;
    
    // 频率范围
    config.startFreqHz = 433050000;   // 起始频率：433.05 MHz
    config.endFreqHz = 434790000;     // 结束频率：434.79 MHz
    config.freqStepHz = 100000;        // 频率步进：100 kHz
    
    // LoRa 参数
    config.rxWindowMs = 1000;          // RX窗口：1000 ms
    config.bandwidth = 125;            // 带宽：125 kHz
    config.spreadingFactor = 9;        // 扩频因子：SF9
    config.codingRate = 5;             // 编码率：4/5
    config.maxPoints = 100;           // 最大雷达点数：100
    
    return config;
}
```

## 显示视图详解

### 视图0：Radar（雷达视图）- 默认视图

#### 显示内容
- **圆形雷达图**：显示不同频点的信号分布
- **同心圆**：表示信号强度（外圈弱，内圈强）
- **角度位置**：表示频点位置（从起始频率到结束频率围绕圆圈展开）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径3） | 信号强（> -70 dBm） |
| 🟡 黄色 | 大（半径3） | 信号中等（-80 ~ -70 dBm） |
| 🟠 橙色 | 大（半径3） | 信号弱（-90 ~ -80 dBm） |
| 🔴 红色 | 大/小（半径3/2） | CRC错误 |

#### 如何阅读
1. **查看频点分布**：不同角度代表不同频点，从起始频率到结束频率顺时针排列
2. **查看信号强度**：圆点越靠近中心，信号越强；越靠近外圈，信号越弱
3. **查看信号质量**：绿色表示强信号，黄色表示中等信号，橙色表示弱信号，红色表示错误
4. **查看活动密度**：某个角度的点越密集，表示该频点活动越频繁
5. **查看信号稳定性**：某个角度的点越集中，表示该频点信号越稳定

### 视图1：Timeline（时间线视图）

#### 显示内容
- **X轴**：时间（最近60秒）
- **Y轴**：信号强度（-120 dBm 到 -50 dBm）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径4） | 成功接收数据包 |
| 🟢 绿色 | 小（半径2） | 成功接收但无数据 |
| 🔴 红色 | 小（半径2） | CRC错误 |

#### 如何阅读
1. **查看信号趋势**：从左到右，时间从早到晚
2. **查看信号强度**：圆点越靠上，信号越强
3. **查看接收质量**：绿色点多表示接收成功，红色点多表示干扰或信号质量差
4. **查看活动频率**：圆点越密集，表示活动越频繁

### 视图2：RSSI Histogram（RSSI直方图视图）

#### 显示内容
- **X轴**：信号强度区间（-120 ~ -50 dBm）
- **Y轴**：事件数量
- **柱状图**：每个柱子表示一个信号强度区间的事件数量

#### 如何阅读
1. **查看信号分布**：柱子越高，表示该信号强度区间的事件越多
2. **查看信号质量**：如果大部分柱子在左侧（弱信号），说明信号质量差
3. **查看信号稳定性**：如果柱子分布集中，说明信号稳定；如果分布分散，说明信号波动大

### 视图3：Event List（事件列表视图）

#### 显示内容
- **列表**：显示最近的接收事件
- **每行信息**：
  - 时间（相对时间，如 "5s ago"）
  - 频率（MHz）
  - RSSI（dBm）
  - 事件类型（✓ 成功，✗ 错误）

#### 如何阅读
1. **查看最近事件**：列表按时间倒序排列，最新事件在最上面
2. **查看事件详情**：每个事件显示时间、频率、RSSI和类型
3. **查看接收质量**：成功事件多表示接收质量好

### 视图4：Statistics（统计信息视图）

#### 显示内容
- **总事件数**：所有接收事件的总数
- **成功接收数**：成功接收数据包的数量
- **错误接收数**：CRC错误的数量
- **平均 RSSI**：所有事件的平均信号强度
- **最大 RSSI**：最强信号
- **最小 RSSI**：最弱信号
- **成功率**：成功接收数 / 总事件数

#### 如何阅读
1. **查看整体情况**：总事件数表示活动强度
2. **查看接收质量**：成功率越高，接收质量越好
3. **查看信号强度**：平均 RSSI 表示整体信号质量

### 视图5：Frequency Comparison（频点对比视图）

#### 显示内容
- **列表**：显示所有配置的频点
- **每行信息**：
  - 频率值（MHz）
  - 当前频点高亮显示

#### 如何阅读
```
示例：
433.05 MHz
433.15 MHz
433.25 MHz  ← 当前频点（青色高亮）
433.35 MHz
...
```

1. **查看所有频点**：列表显示所有配置的频点
2. **快速切换频点**：使用 `-` 和 `=` 键切换，列表会滚动显示
3. **查看当前频点**：当前频点以青色高亮显示
4. **对比频点**：可以快速浏览所有频点，选择合适的频点

### 视图6：Realtime Monitor（实时监测视图）

#### 显示内容
- **X轴**：时间（最近10秒）
- **Y轴**：信号强度（-120 dBm 到 -50 dBm）
- **数据点**：每个接收事件显示为一个圆点

#### 图例
| 圆点颜色 | 圆点大小 | 含义 |
|---------|---------|------|
| 🟢 绿色 | 大（半径3） | 成功接收数据包 |
| 🟢 绿色 | 小（半径2） | 成功接收但无数据 |
| 🔴 红色 | 小（半径2） | CRC错误 |

#### 如何阅读
1. **查看实时信号**：圆点越靠上，信号越强
2. **查看信号波动**：圆点分布越集中，信号越稳定
3. **查看接收质量**：绿色点多表示接收成功，红色点多表示干扰或信号质量差
4. **查看时间趋势**：从右到左，越靠左越早

## 状态栏说明

状态栏显示以下信息：

| 元素 | 位置 | 说明 |
|------|------|------|
| 模块名称 | 左侧 | 显示 LoRa 模块名称（如 "E220"） |
| 频率 | 中间 | 显示当前扫描频率（如 "433.05 MHz"） |
| 扫描图标 | 右侧 | 🟢 绿色：正在扫描，⚪ 灰色：已停止 |
| RSSI指示器 | 右侧 | 显示最近一次接收的信号强度（4格） |
| 电池指示器 | 右侧 | 显示电池电量 |

#### RSSI指示器图例
| 格数 | 颜色 | RSSI 范围 | 含义 |
|------|------|-----------|------|
| 4格 | 🟢 绿色 | > -70 dBm | 信号很强 |
| 3格 | 🟢 绿色 | -80 ~ -70 dBm | 信号强 |
| 2格 | 🟡 黄色 | -90 ~ -80 dBm | 信号中等 |
| 1格 | 🔴 红色 | -100 ~ -90 dBm | 信号弱 |
| 0格 | 无显示 | < -100 dBm | 无信号 |

## 使用建议

1. **快速查看信号质量**：使用 Timeline 视图
2. **分析信号分布**：使用 RSSI Histogram 视图
3. **查看详细事件**：使用 Event List 视图
4. **查看统计数据**：使用 Statistics 视图
5. **对比所有频点**：使用 Frequency Comparison 视图
6. **实时监测信号**：使用 Realtime Monitor 视图
7. **可视化频点分布**：使用 Radar 视图（默认）

## 扩展方向

### Phase 2 功能
- 频点自动发现（扫描整个 433MHz ISM 频段）
- 历史数据记录到 SD 卡
- 阈值告警（检测到异常活动时提示）
- 数据导出（CSV/JSON）

### Phase 3 功能
- 多设备协同扫描
- 网络同步（ESP-NOW）
- 高级分析（模式识别、周期性检测）

## 设计决策说明

### 为什么使用 FreeRTOS 任务？
- 监听操作可能耗时，不应阻塞主循环
- 独立任务确保 UI 响应流畅
- 便于后续扩展（如添加网络同步）

### 为什么使用滑动窗口？
- 避免历史数据干扰当前统计
- 限制内存使用
- 提供稳定的统计结果

### 为什么支持多种显示模式？
- 不同使用场景需要不同的可视化方式
- 用户可以根据需求选择最合适的视图
- 提供全面的射频环境监测体验

### 为什么雷达视图作为默认视图？
- 雷达视图可以直观展示所有频点的信号分布
- 一目了然地看出哪个频点有信号
- 视觉效果酷炫，用户体验好

### 为什么支持多种 LoRa 模块？
- 不同应用场景可能需要不同模块
- 便于硬件升级
- 提高项目通用性

### 为什么分离框架配置和用户配置？
- 用户只需修改 config_user.h 即可自定义功能
- 框架配置保持稳定，减少误操作
- 提供合理的默认值，降低使用门槛

## 性能考虑

### 内存使用
- 滑动窗口大小：100 个雷达点
- 频点统计：按需创建
- 总内存占用：< 50KB

### CPU 使用
- 监听任务：优先级 2
- 主循环：100ms 周期
- 显示更新：每周期一次

### 实时性
- 监听延迟：< 100ms
- UI 响应：< 50ms
- 数据更新：实时

## 测试建议

### 1. 单元测试
- 测试各模块的独立功能
- 验证边界条件
- 检查内存泄漏

### 2. 集成测试
- 测试模块间协作
- 验证数据流
- 检查性能指标

### 3. 现场测试
- 实际环境扫描
- 验证各视图显示
- 收集用户反馈

## 已知限制

1. **频点数量**：受内存限制，建议不超过 20 个频点
2. **扫描速度**：每个频点 RX 窗口时间建议 >= 500ms
3. **显示刷新**：受屏幕性能限制，建议 100ms 刷新周期
4. **数据持久化**：当前版本不支持数据保存
5. **雷达视图**：频点标签只显示有信号的频点，无信号频点不显示

## 总结

LoRaScope 项目成功实现了一个功能完整、可扩展的 LoRa 射频环境感知工具。通过模块化设计、抽象接口和合理的架构，项目具有良好的可维护性和扩展性。七种显示模式（包括默认的雷达视图）为用户提供了准确、直观的射频环境监测体验。

项目已准备好进行编译、上传和实际测试。后续可根据实际使用反馈进行优化和功能扩展。
